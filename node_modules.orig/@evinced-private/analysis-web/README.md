# Analysis Web SDK

This is the analysis-client bundle that is shared by our web SDKs and published to [NPM](https://www.npmjs.com/package/@evinced/analysis-web) as a private package.

## Publish to NPM

1. `npm run build`
2. Bump version in `package.json`
3. `npm publish --access restricted --dry-run`
4. Verify that the package contents is correct
5. `npm publish --access restricted`
6. Enter 2FA OTP

## pre_publish script  

This script do this steps:  
1. creates `sdk/publish_pr_description.txt` file, that contains two parts:  
    1. Everything from head of file `sdk/CHANGELOG.md` until first release version (`## v`)  
    2. Commit names since last `[Publish] analysis-web/` without `[skip ci]` commit names  
2. bumps version of sdk (you decide what to bump - major, minor or patch)  
3. replaces WIP to actual version and date
4. creates new branch from current branch and gives it new name `publish/analysis-web/${VERSION}/${CURRENT_DATE}_${CURRENT_TIMESTAMP}`   
5. pushes the new branch to git  
6. creates new PR with name `[Publish] analysis-web/${VERSION}` from the `publish` branch to master (description from `sdk/publish_pr_description.txt`)  
7. deletes `sdk/publish_pr_description.txt`

### Prerequisites   
Before using `ci-scripts/pre_publish.py` you must:   
1. install python3.7 or higher  
2. install gh cli tool (https://github.com/cli/cli)   
3. run `gh auth login` and authenticate to your github account   

### Usage
You can run `ci-scripts/pre_publish.py` in interactive mode by running:   
`python3 ci-scripts/pre_publish.py` (from project root) or `npm run pre-publish`.  

You can run `ci-scripts/pre_publish.py` in automatic mode by running script with key `--bump` and one of parameters '`major|minor|patch`'.   
This parameter gives you an opportunity to select what to bump in package version.   
For example:     
`python3 ci-scripts/pre_publish.py --bump patch` (from project root)  
Or you can run 'npm run pre-publish-auto-`major|minor|patch`'.  
For example:
`npm run pre-publish-auto-major` to run script in automatic mode and bump major version.

If you don't want to install anything on your PC, you can use CI pipeline in automatic mode.  
1.  proceed to your branch in CircleCI (https://app.circleci.com/pipelines/github/GetEvinced/semantic-engine)    
2.  log in to circleci.com using your Github account (if needed)
3.  push the button "Run Pipeline"  
4.  add "string" parameter "version_bump" with one of the parameters "`major`, `minor` or `patch`"   
5.  push the button "Run Pipeline"   
6.  in the end of the step "run pre_publish.py" you will see the link with newly created PR.   
For example, `https://github.com/GetEvinced/semantic-engine/pull/NUMBER`  

### Postrequisites  
After running `pre_publish script` you should:  
1. review the PR  
2. make changes if needed (please, don't change first part of the PR's name `[Publish] analysis-web/`)  
3. approve/merge the PR  

After merging the PR, CI will:  
1. check for commit name `[Publish] analysis-web/`   
2. run sdk tests  
3. build sdk  
4. publish sdk to JFrog's directory `private-npm/@evinced-private/analysis-web/${VERSION}`  
5. push git tag `analysis-web/${VERSION}`  
